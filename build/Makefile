
# Specify project name and default compilers
PRJ = fw_app

# Project root WorkSpace
WORKSPACE = ..

# Specify target Microcontroller
ifndef $(DEVICE)
	DEVICE = none
endif

# Specify MCU CPU Frequency
ifndef $(F_CPU)
	F_CPU = 16000000
endif

# Low, High and Extended Fuses Values
ifndef $(LFU)
	LFU = "none"
endif
ifndef $(LFU)
	HFU = "none"
endif
ifndef $(LFU)
	EFU = "none"
endif

# Avrdude Programmer
ifndef $(PROGRAMMER)
	PROGRAMMER = usbasp
endif

# Specify default compilers and tools
CC      = avr-gcc
CXX     = avr-g++
AVRDUDE = avrdude -c $(PROGRAMMER) -p $(DEVICE)
OBJCOPY = avr-objcopy
OBJDUMP = avr-objdump
SIZE    = avr-size --format=avr --mcu=$(DEVICE)

#Setup libs directories to be included
LIBS = -I$(WORKSPACE)/inc
LIBS += -L$(WORKSPACE)/lib

# Setup compilation flags
CFLAGS = -Os -Wall -fstack-usage -mmcu=$(DEVICE) -DF_CPU=$(F_CPU) -g $(LIBS)
CXXFLAGS = -Os -Wall -fstack-usage -mmcu=$(DEVICE) -DF_CPU=$(F_CPU) -g $(LIBS)

# Compile instruction
COMPILE = $(CXX) $(CXXFLAGS)

###############################################################################

# Specify Build and Binary Release directories
BUILDDIR = $(WORKSPACE)/build
BINDIR = $(WORKSPACE)/bin

# Get actual date and setup output binary directory name
#DATE = $(shell date '+%Y_%m_%d_%H_%M_%S')
DATE = $(shell date '+%Y_%m_%d')
RELEASEDIR = $(WORKSPACE)/bin/$(DATE)

# Specify Sources files (Automatic search in specific directories)
SRCS  = $(shell find $(WORKSPACE)/src -type f -name *.c)
SRCS  += $(shell find $(WORKSPACE)/src -type f -name *.cpp)
SRCS  += $(shell find $(WORKSPACE)/lib -type f -name *.c)
SRCS  += $(shell find $(WORKSPACE)/lib -type f -name *.cpp)

# Specify Headers files (Automatic search in specific directories)
HEADS = $(shell find $(WORKSPACE)/inc -type f -name *.h)
HEADS += $(shell find $(WORKSPACE)/inc -type f -name *.hpp)
HEADS += $(shell find $(WORKSPACE)/lib -type f -name *.h)
HEADS += $(shell find $(WORKSPACE)/lib -type f -name *.hpp)

# Get objects files from sources and output object
_OBJS = $(SRCS:.c=.o)
OBJS = $(_OBJS:.cpp=.o)
BUILDOBJS = $(BUILDDIR)/$(shell basename $(OBJS))

###############################################################################

ifdef $(TEST)
	CFLAGS += -DTEST
	CXXFLAGS += -DTEST
endif

ifdef $(BOOTLOADER)
	CFLAGS += -DBOOTLOADER
	CXXFLAGS += -DTEST
endif

###############################################################################

help:
	@cat README.md

# Target: make all (build project generating output directory)
build: $(PRJ).bin
	rm -f ${RELEASEDIR}/*
	mkdir -p ${RELEASEDIR}
	cp -a $(PRJ).elf $(RELEASEDIR)
	cp -a $(PRJ).hex $(RELEASEDIR)
	cp -a $(PRJ).bin $(RELEASEDIR)
	$(SIZE) $(PRJ).elf

# Target: make clean (remove all previously builds)
clean:
	rm -f $(BUILDDIR)/*.o
	rm -f $(BUILDDIR)/*.su
	rm -f $(BUILDDIR)/$(PRJ).elf
	rm -f $(BUILDDIR)/$(PRJ).hex
	rm -f $(BUILDDIR)/$(PRJ).bin
	rm -f $(BUILDDIR)/dump.bin
	rm -f $(BUILDDIR)/dump.hex

# Target: make rebuild (clean previously builds and build again)
rebuild: clean all

# Flash program to MCU
flash: build
	$(AVRDUDE) -U flash:w:$(PRJ).hex:i

# Write fuses to MCU
fuse:
	$(AVRDUDE) -U lfuse:w:$(LFU):m -U hfuse:w:$(HFU):m -U efuse:w:$(EFU):m

# Read flash memory from MCU
dump:
	rm -f $(BUILDDIR)/dump.bin
	rm -f $(BUILDDIR)/dump.hex
	$(AVRDUDE) -U flash:r:dump.bin:r
	$(OBJCOPY) -I binary -O ihex dump.bin dump.hex

# Target: check (custom target to check build variables)
check:
	@echo "HEADERS:"
	@echo "  $(HEADS)"
	@echo "SRCS:"
	@echo "  $(SRCS)"
	@echo "OBJS:"
	@echo "  $(BUILDOBJS)"
	@echo "BINDIR:"
	@echo "  $(BINDIR)"

###############################################################################

# Target for generate BIN file from .elf file
$(PRJ).bin: $(PRJ).hex
	rm -f $(PRJ).bin
	$(OBJCOPY) -j .text -j .data -O binary $(PRJ).elf $(PRJ).bin

# Target for generate HEX file from .elf file
$(PRJ).hex: $(PRJ).elf
	rm -f $(PRJ).hex
	$(OBJCOPY) -j .text -j .data -O ihex $(PRJ).elf $(PRJ).hex

# Target for generate ELF file linking all .o files
$(PRJ).elf: $(OBJS)
	$(CC) $(CFLAGS) -o $(PRJ).elf $(BUILDOBJS)

# Target for generate object file of each .c file
%.o: %.c
	$(CC) $(CFLAGS) -c $<

# Target for generate object file of each .cpp file
%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $<
